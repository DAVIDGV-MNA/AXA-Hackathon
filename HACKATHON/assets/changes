import hashlib

def stable_chunk_id(path: str, page: int, text: str) -> str:
    # deterministic id: path + page + normalized text fingerprint
    norm = " ".join(text.split()).lower()
    h = hashlib.blake2b(digest_size=16)
    h.update(path.encode("utf-8"))
    h.update(f"|p{page}|".encode("utf-8"))
    h.update(norm.encode("utf-8"))
    return h.hexdigest()

"id": stable_chunk_id(str(path), page, ch),

def ensure_index_ready():
    index, meta = load_store()
    if index is None or index.ntotal == 0:
        raise HTTPException(status_code=503, detail="Index not built. Call /rag/reindex first.")
    return index, meta


